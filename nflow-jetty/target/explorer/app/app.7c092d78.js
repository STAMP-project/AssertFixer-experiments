"use strict";function capitalize(a){return!a||!a.length||a.length<1?a:a.charAt(0).toUpperCase()+a.slice(1)}var guid=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}();!function(){var a=angular.module("nflowExplorer",["nflowExplorer.about","nflowExplorer.config","nflowExplorer.components","nflowExplorer.frontPage","nflowExplorer.layout","nflowExplorer.search","nflowExplorer.executors","nflowExplorer.services","nflowExplorer.workflow","nflowExplorer.workflowDefinition","nflowExplorer.workflowStats","ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.bootstrap"]);a.run(["EndpointService","ExecutorService",function(a,b){a.init(),b.start()}])}(),angular.module("nflowExplorer.about",[]).controller("AboutCtrl",["$scope","config",function(a,b){a.nflowUrl=function(){return b.nflowUrl},a.nflowApiDocs=function(){return b.nflowApiDocs}}]),function(){angular.module("nflowExplorer.config",["nflowExplorer.config.console","nflowExplorer.config.routes"]).constant("config",new Config)}(),function(){angular.module("nflowExplorer.config.console",[]).config(function(){var a=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],b=window.console=window.console||{};_.forEachRight(a,function(a){b[a]||(b[a]=_.noop)})})}(),function(){var a=angular.module("nflowExplorer.config.routes",["nflowExplorer.services","ui.router"]);a.config(["$stateProvider","$urlRouterProvider",function(a,b){function c(a,b){return a.get(b).then(_.first)}function d(a){return a.loadCss()}d.$inject=["GraphService"],b.otherwise("/"),a.state("frontPageTab",{"abstract":!0,template:"<div ui-view></div>"}),a.state("searchTab",{"abstract":!0,template:"<div ui-view></div>"}),a.state("executorsTab",{"abstract":!0,template:"<div ui-view></div>"}),a.state("aboutTab",{"abstract":!0,template:"<div ui-view></div>"}),a.state("frontPage",{parent:"frontPageTab",url:"/",templateUrl:"app/front-page/frontPage.html",controller:"FrontPageCtrl as ctrl"}).state("search",{parent:"searchTab",url:"/search?type&state&parentWorkflowId",templateUrl:"app/search/search.html",controller:"SearchCtrl as ctrl",resolve:{definitions:["WorkflowDefinitionService",function(a){return a.list()}]}}).state("executors",{parent:"executorsTab",url:"/executors",templateUrl:"app/executors/executors.html",controller:"ExecutorsCtrl as ctrl"}).state("about",{parent:"aboutTab",url:"/about",templateUrl:"app/about/about.html",controller:"AboutCtrl"}).state("workflow-stats",{parent:"frontPageTab",url:"/workflow-stats?type",templateUrl:"app/workflow-stats/workflowStats.html",controller:"RadiatorCtrl"}).state("workflow-definition",{parent:"frontPageTab",url:"/workflow-definition/:type",templateUrl:"app/workflow-definition/workflowDefinition.html",controller:"WorkflowDefinitionCtrl as ctrl",resolve:{loadCss:d,definition:["WorkflowDefinitionService","$stateParams",function(a,b){return c(a,b.type)}]}}).state("workflow",{parent:"searchTab",url:"/workflow/:id",templateUrl:"app/workflow/workflow.html",controller:"WorkflowCtrl as ctrl",resolve:{loadCss:d,workflow:["WorkflowService","$stateParams",function(a,b){return a.get(b.id)}],definition:["WorkflowDefinitionService","workflow",function(a,b){return c(a,b.type)}],parentWorkflow:["WorkflowService","workflow",function(a,b){if(b.parentWorkflowId)return a.get(b.parentWorkflowId)}],childWorkflows:["WorkflowService","$stateParams",function(a,b){return a.query({parentWorkflowId:b.id})}]}})}])}(),function(){angular.module("nflowExplorer.components",["nflowExplorer.components.endpointSelection","nflowExplorer.components.constants","nflowExplorer.components.filters","nflowExplorer.components.graph","nflowExplorer.components.util"])}(),function(){var a=angular.module("nflowExplorer.components.constants",[]);a.constant("WorkflowStateType",{START:"start",MANUAL:"manual",NORMAL:"normal",END:"end",ERROR:"error"}),a.constant("WorkflowInstanceStatus",{CREATED:"created",IN_PROGRESS:"inProgress",FINISHED:"finished",MANUAL:"manual"})}(),function(){angular.module("nflowExplorer.components.filters",[]).filter("reverse",function(){return function(a){return a?a.slice().reverse():[]}}).filter("fromNow",function(){return function(a){if(!a)return"";try{return moment(a).fromNow()}catch(b){return a}}}).filter("fromNowOrNever",function(){return function(a){if(!a)return"never";try{return moment(a).fromNow()}catch(b){return a}}}).filter("prettyPrintJson",function(){return function(a){try{return JSON.stringify(a,void 0,2)}catch(b){return a}}}).filter("nullToZero",function(){return function(a){return a?a:0}})}(),function(){var a=angular.module("nflowExplorer.components.graph",[]);a.factory("Graph",function(){function a(a,b,c){function d(b,c){_.each(a.incidentEdges(b,c),function(a){e("#"+h(a))})}function e(a){d3.select(a).classed("selected",c)}_.each(a.predecessors(b),function(a){d(a,b)}),_.each(a.successors(b),function(a){d(b,a)}),e("#"+g(b))}function b(a){d3.select("#"+g(a.state)).classed("current-state",!0)}function c(a,b){var c=document.createElement("a");"download"in c?(console.debug("Download via a.href,a.download"),c.download=b,c.href=a,c.click()):(console.debug("Download via location.href"),location.href=a)}function d(a,b,d,e){console.info("Downloading image",d,e);var f=document.createElement("canvas"),g=f.getContext("2d");f.width=a[0],f.height=a[1];var h=new Image;h.width=f.width,h.height=f.height,h.onload=function(){g.drawImage(h,0,0,this.width,this.height);var a=f.toDataURL(e);c(a,d)},h.onerror=function(a){console.error("Image downloading failed",a)},h.src=b}function e(a,b){function c(){function c(){_.forEach(a.states,function(a){e.addNode(a.id,f(a,b))})}function d(){_.chain(_.result(b,"actions")).filter(function(a){return!e._nodes(a.state)}).forEach(function(a){e.addNode(a.state,f({name:a.state},b))})}function f(a,b){function c(){function c(){return b.state===a.id||!_.isUndefined(_.find(b.actions,"state",a.id))}var d="node-"+(_.includes(["start","manual","end","error"],a.type)?a.type:"normal");return b&&!c()&&(d+=" node-passive"),d}function d(){return _.reduce(_.result(b,"actions"),function(b,c){return c.state===a.id&&c.retryNo>0?b+1:b},0)}var e={};return e["class"]=c(),e.retries=d(),e.state=a,e.label=a.id,e}c(),d()}function d(){function c(){_.forEach(a.states,function(a){_.forEach(a.transitions,function(c){e.addEdge(null,a.id,c,g(b,a,c))}),a.onFailure&&e.addEdge(null,a.id,a.onFailure,g(b,a,a.onFailure,!0))})}function d(){var c=a.onError;_.forEach(a.states,function(a){a.id===c||a.onFailure||"end"===a.type||_.includes(a.transitions,c)||e.addEdge(null,a.id,c,g(b,a,c,!0))})}function f(){if(b){var a={},c=null,d=b.actions.slice().reverse();_.each(d,function(b){return a[b.state]||(a[b.state]={}),c?(c!==b.state&&(a[c][b.state]=!0),void(c=b.state)):void(c=b.state)});var f=_.last(d);f&&f.state!==b.state&&(a[f.state][b.state]=!0),_.each(a,function(a,b){_.each(Object.keys(a),function(a){a&&(e.inEdges(a,b).length||e.addEdge(null,b,a,{"class":"edge-unexpected edge-active"}))})})}}function g(a,b,c,d){function e(){function e(b,c){var d=a.actions.slice().reverse();if(_.size(d)<2)return!1;var e=_.first(d).state,f=_.find(_.rest(d),function(a){return e===b.id&&a.state===c||void(e=a.state)});return!_.isUndefined(f)||_.last(d).state===b.id&&a.state===c}var f="edge-"+(d?"error":"normal");return a&&(f+=" edge-"+(e(b,c)?"active":"passive")),f}return{"class":e()}}c(),d(),f()}var e=new dagreD3.Digraph;return c(),d(),e}function f(a,b,c,d){function e(a,b){var c=d3.select(a);return c.selectAll("*").remove(),c.append("style").attr("type","text/css").text(b),c.classed("svg-content-responsive",!0),c}function f(a,b,c){function d(){var c=b.select("rect.overlay");c.attr("style",""),c.attr("class","graph-background"),c.on("click",function(){a(null)})}function e(){b.on("mousedown.zoom",null),b.on("mousemove.zoom",null),b.on("dblclick.zoom",null),b.on("touchstart.zoom",null),b.on("wheel.zoom",null),b.on("mousewheel.zoom",null),b.on("MozMousePixelScroll.zoom",null)}function f(){b.attr("preserveAspectRatio","xMinYMin meet"),b.attr("viewBox","0 0 "+(c.graph().width+40)+" "+(c.graph().height+40))}d(),e(),f()}function i(a,b,c){var d=c.append("g");return d.attr("transform","translate(20, 20)"),a.run(b,d)}function j(a,b,c){var d=a.drawNodes();a.drawNodes(function(a,e){function f(){var b={};i.selectAll("rect").each(function(a){var c=d3.select(this);b[a]={x:c.attr("x"),y:c.attr("y")}});var c=i.append("g");c.each(function(c){var d=a.node(c);if(d.retries>0){var e=b[c],f=d3.select(this);f.attr("transform","translate("+-e.x+",-4)"),f.append("ellipse").attr("cx",10).attr("cy",-5).attr("rx",20).attr("ry",10).attr("class","retry-indicator"),f.append("text").append("tspan").text(d.retries),f.append("title").text("State was retried "+d.retries+" times.")}})}function h(a){return _.capitalize(a.type)+" state\n"+a.description}var i=d(b,e);return i.attr("style",function(){return"opacity: 1; cursor: pointer;"}),i.append("title").text(function(b){return h(a.node(b).state)}),i.attr("id",function(a){return g(a)}),i.attr("class",function(b){return a.node(b)["class"]}),i.on("click",function(a){c(a)}),f(),i})}function k(a){var b=a.drawEdgePaths();a.drawEdgePaths(function(a,c){var d=b(a,c);return d.selectAll("*").attr("id",function(a){return h(a)}).attr("class",function(b){return a._edges[b].value["class"]}),d})}function l(a){m(a,"arrowhead-gray","gray"),m(a,"arrowhead-red","red")}function m(a,b,c){d3.select(a).select("defs").append("marker").attr("id",b).attr("viewBox","0 0 10 10").attr("refX",8).attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","8").attr("markerHeight","5").attr("orient","auto").attr("fill",c).append("path").attr("d","M 0 0 L 10 5 L 0 10 z")}var n=new dagreD3.Renderer;j(n,a,c),k(n);var o=e(b,d),p=i(n,a,o);return l(b),f(c,o,p),p}function g(a){return"node_"+a}function h(a){return"edge"+a}return{setNodeSelected:a,markCurrentState:b,workflowDefinitionGraph:e,drawWorkflowDefinition:f,downloadDataUrl:c,downloadImage:d}})}(),function(){var a=angular.module("nflowExplorer.components.util",[]);a.directive("emptyToNull",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return""===a?null:a})}}})}(),function(){var a=angular.module("nflowExplorer.components.endpointSelection",[]);a.directive("endpointSelection",function(){return{scope:{},bindToController:!0,restrict:"E",controller:"EndpointSelectionCtrl as ctrl",templateUrl:"app/components/endpointSelection/endpointSelection.html"}}),a.controller("EndpointSelectionCtrl",["config","EndpointService",function(a,b){var c=this;c.endpoints=a.nflowEndpoints,c.selectedEndpoint=b.currentEndpoint(),c.endpointChange=function(a){b.selectEndpoint(a)}}])}(),function(){var a=angular.module("nflowExplorer.executors",["nflowExplorer.executors.executorTable","nflowExplorer.services"]);a.controller("ExecutorsCtrl",["ExecutorService",function(a){var b=this;b.executors=a.executors}])}(),function(){var a=angular.module("nflowExplorer.executors.executorTable",["nflowExplorer.services","nflowExplorer.components"]);a.directive("executorTable",function(){return{restrict:"E",replace:!0,scope:{executors:"="},bindToController:!0,controller:"ExecutorTableCtrl as ctrl",templateUrl:"app/executors/executorTable.html"}}),a.controller("ExecutorTableCtrl",["Time",function(a){function b(b){var c=a.currentMoment().add(-24,"hours");if(!b.expires)return moment(b.started).isAfter(c);var d=moment(b.expires);return!d.isBefore(c)}function c(b,c){if(c=c||a.currentMoment(),!b.expires){if(moment(b.started).add(1,"days").isBefore(c))return;return moment(b.started).add(1,"hours").isBefore(c)?"warning":"success"}if(!moment(b.active).add(1,"days").isBefore(c))return moment(b.expires).isBefore(c)?"warning":"success"}var d=this;d.executorClass=c,d.isActive=b}])}(),function(){var a=angular.module("nflowExplorer.frontPage",["nflowExplorer.frontPage.definitionList","nflowExplorer.services"]);a.controller("FrontPageCtrl",["WorkflowDefinitionService",function(a){var b=this;a.list().then(function(a){b.definitions=a})}])}(),function(){var a=angular.module("nflowExplorer.frontPage.definitionList",[]);a.directive("definitionList",function(){return{restrict:"E",replace:!0,scope:{definitions:"="},bindToController:!0,controller:"DefinitionListCtrl as ctrl",templateUrl:"app/front-page/definitionList.html"}}),a.controller("DefinitionListCtrl",["$scope","$location",function(a,b){a.showDefinition=function(a){b.path("workflow-definition/"+a)}}])}(),function(){var a=angular.module("nflowExplorer.layout",[]);a.directive("layout",function(){return{restrict:"E",replace:"true",templateUrl:"app/layout/layout.html"}}),a.directive("pageHeader",function(){return{restrict:"E",replace:"true",templateUrl:"app/layout/header.html",controller:"PageHeaderCtrl as ctrl"}}),a.directive("pageFooter",function(){return{restrict:"E",replace:"true",templateUrl:"app/layout/footer.html"}}),a.controller("PageHeaderCtrl",["$location","$state",function(a,b){var c=this;c.radiator=!!a.search().radiator,c.isFrontPageTabActive=function(){return b.includes("frontPageTab")},c.isExecutorsTabActive=function(){return b.includes("executorsTab")},c.isSearchTabActive=function(){return b.includes("searchTab")},c.isAboutTabActive=function(){return b.includes("aboutTab")}}])}(),function(){var a=angular.module("nflowExplorer.search.criteriaModel",[]);a.factory("CriteriaModel",function(){function a(a,b){angular.copy({},i.model),i.model.definition=e(a.type,b),i.model.state=f(a.stateId,i.model.definition),i.model.parentWorkflowId=h(a.parentWorkflowId)}function b(){var a={};return a.type=_.result(i.model.definition,"type"),a.state=_.result(i.model.state,"id"),_.defaults(a,_.omit(i.model,["definition","state"])),g(a)}function c(){return _.isEmpty(g(i.model))}function d(){i.model.state=f(_.result(i.model.state,"id"),i.model.definition)}function e(a,b){return h(_.find(b,function(b){return b.type===a}))}function f(a,b){return b?h(_.find(b.states,function(b){return b.id===a})):null}function g(a){return _.omit(a,function(a){return _.isUndefined(a)||_.isNull(a)})}function h(a){return a||null}var i={};return i.model={},i.initialize=a,i.toQuery=b,i.isEmpty=c,i.onDefinitionChange=d,i})}(),function(){var a=angular.module("nflowExplorer.search",["nflowExplorer.search.criteriaModel","nflowExplorer.search.searchForm","nflowExplorer.search.searchResult"]);a.controller("SearchCtrl",["$stateParams","definitions","CriteriaModel",function(a,b,c){function d(){return void 0!==f.results}function e(a){try{return parseInt(a)}catch(b){return}}var f=this;f.definitions=b,f.results=void 0,f.hasResults=d,c.initialize({type:a.type,stateId:a.state,parentWorkflowId:e(a.parentWorkflowId)},b)}])}(),function(){var a=angular.module("nflowExplorer.search.searchForm",["nflowExplorer.search.criteriaModel","nflowExplorer.services","nflowExplorer.components"]);a.directive("searchForm",function(){return{restrict:"E",replace:!0,scope:{results:"=",definitions:"="},bindToController:!0,controller:"SearchFormCtrl",controllerAs:"ctrl",templateUrl:"app/search/searchForm.html"}}),a.controller("SearchFormCtrl",["$timeout","CriteriaModel","WorkflowService","WorkflowInstanceStatus",function(a,b,c,d){function e(){b.isEmpty()||f()}function f(){function d(){a.cancel(e),g.showIndicator=!1}var e=a(function(){g.showIndicator=!0},500);c.query(b.toQuery()).then(function(a){g.results=a,d()})["catch"](d)}var g=this;g.showIndicator=!1,g.instanceStatuses=_.values(d),g.model=b.model,g.search=f,g.onTypeChange=b.onDefinitionChange,e()}])}(),function(){var a=angular.module("nflowExplorer.search.searchResult",["nflowExplorer.components"]);a.directive("searchResult",function(){return{restrict:"E",replace:!0,scope:{results:"=",definitions:"="},bindToController:!0,controller:"SearchResultCtrl as ctrl",templateUrl:"app/search/searchResult.html"}}),a.controller("SearchResultCtrl",["WorkflowStateType",function(a){function b(a){if(!a)return"";var b=_.find(c.definitions,function(b){return b.type===a.type});if(b){var e=_.find(b.states,function(b){return b.id===a.state});if(e)return e.id===b.onError?"danger":d[e.type]||""}return""}var c=this;c.getStateClass=b;var d={};d[a.NORMAL]="info",d[a.MANUAL]="warning",d[a.END]="success",d[a.ERROR]="danger"}])}(),function(){angular.module("nflowExplorer.services",["nflowExplorer.config","nflowExplorer.services.EndpointService","nflowExplorer.services.ExecutorService","nflowExplorer.services.GraphService","nflowExplorer.services.Time","nflowExplorer.services.WorkflowDefinitionService","nflowExplorer.services.WorkflowService","nflowExplorer.services.WorkflowStatsPoller"])}(),function(){var a=angular.module("nflowExplorer.services.EndpointService",["nflowExplorer.config"]);a.service("EndpointService",["config","$window",function(a,b){function c(){return a.selectedEndpoint}function d(c){if(c){var d=a.selectedEndpoint&&a.selectedEndpoint.id!==c.id;a.selectedEndpoint=c,a.nflowUrl=c.apiUrl,a.nflowApiDocs=c.docUrl;try{b.localStorage.setItem("nflow.endpoint",c.id)}catch(e){}d&&b.location.reload()}}function e(b){if(!b)return void d(_.first(a.nflowEndpoints));var c=_.find(h.availableEndpoints(),{id:b});d(c)}function f(){var a;try{a=b.localStorage.getItem("nflow.endpoint")}catch(c){a=b.sessionStorage.getItem("nflow.endpoint")}e(a)}function g(){return a.nflowEndpoints}var h=this;h.currentEndpoint=c,h.selectEndpoint=e,h.availableEndpoints=g,h.init=f}])}(),function(){var a=angular.module("nflowExplorer.services.ExecutorService",["nflowExplorer.config"]);a.service("ExecutorService",["config","$http","$interval",function(a,b,c){function d(){return b({url:a.nflowUrl+"/v1/workflow-executor"}).then(function(a){return a.data})}function e(){g||(g=!0,console.info("Start executor poller with period ",a.radiator.pollPeriod," seconds"),f(),c(f,1e3*a.radiator.pollPeriod)),console.info("Executor poller already started")}function f(){console.info("Fetching executors"),h.list().then(function(a){angular.copy(a,h.executors)})}var g=!1,h=this;h.list=d,h.start=e,h.executors=[]}])}(),function(){var a=angular.module("nflowExplorer.services.GraphService",[]);a.service("GraphService",["$q","$http","$rootScope",function(a,b,c){this.loadCss=function(){var d=a.defer();return b.get("styles/data/graph.css").success(function(a){c.graph={},c.graph.css=a,d.resolve()}).error(function(){console.warn("Failed to load graph.css"),c.graph={},d.resolve()}),d.promise}}])}(),function(){var a=angular.module("nflowExplorer.services.Time",[]);a.service("Time",function(){var a=this;a.currentMoment=function(){return moment()}})}(),function(){var a=angular.module("nflowExplorer.services.WorkflowDefinitionService",["ngResource"]);a.service("WorkflowDefinitionService",["config","$resource","$http","$cacheFactory",function(a,b,c,d){function e(c){var d=b(a.nflowUrl+"/v1/workflow-definition",{type:"@type"},{get:{isArray:!0,method:"GET",cache:i}});return d.get({type:c}).$promise}function f(){var c=b(a.nflowUrl+"/v1/workflow-definition",{type:"@type"},{query:{isArray:!0,method:"GET",cache:j}});return c.query().$promise}function g(c){var d=b(a.nflowUrl+"/v1/statistics/workflow/:type",{type:"@type"});return d.get({type:c}).$promise}var h=this;h.get=e,h.list=f,h.getStats=g;var i=d("workflow-definition"),j=d("workflow-definition-list")}])}(),function(){var a=angular.module("nflowExplorer.services.WorkflowStatsPoller",["nflowExplorer.services.WorkflowDefinitionService"]);a.service("WorkflowStatsPoller",["$rootScope","config","$interval","WorkflowDefinitionService",function(a,b,c,d){function e(a,c,d){var e=g[a].data;for(e.push([c,d]);e.length>b.maxHistorySize;)e.shift()}function f(b){d.getStats(b).then(function(c){console.info("Fetched statistics for "+b),e(b,new Date,c),g[b].latest=c,a.$broadcast("workflowStatsUpdated",b)})["catch"](function(){console.error("Fetching workflow "+b+" stats failed"),e(b,new Date,{}),a.$broadcast("workflowStatsUpdated",b)})}var g={};this.start=function(a){return!g[a]&&(g[a]={},g[a].data=[],console.info("Start stats poller for "+a+" with period "+b.radiator.pollPeriod+" seconds"),f(a),g[a].poller=c(function(){f(a)},1e3*b.radiator.pollPeriod),!0)},this.getLatest=function(a){if(g[a])return g[a].latest}}])}(),function(){var a=angular.module("nflowExplorer.services.WorkflowService",["nflowExplorer.config","ngResource"]);a.service("WorkflowService",["config","$http","$resource",function(a,b,c){function d(c){return b({url:a.nflowUrl+"/v1/workflow-instance/"+c+"?include=actions,currentStateVariables,actionStateVariables"}).then(function(a){return a.data})}function e(c,d){return b({url:a.nflowUrl+"/v1/workflow-instance/"+c,method:"PUT",data:d}).then(function(a){return a.data})}function f(c,d){return b({url:a.nflowUrl+"/v1/workflow-instance/"+c+"/signal",method:"PUT",data:d}).then(function(a){return a.data})}function g(b){var d=c(a.nflowUrl+"/v1/workflow-instance");return d.query(b).$promise}var h=this;h.get=d,h.update=e,h.query=g,h.signal=f}])}(),function(){var a=angular.module("nflowExplorer.workflow",["nflowExplorer.workflow.graph","nflowExplorer.workflow.info","nflowExplorer.workflow.tabs"]);a.controller("WorkflowCtrl",["workflow","definition","parentWorkflow","childWorkflows",function(a,b,c,d){var e=this;e.workflow=a,e.parentWorkflow=c,e.definition=b,e.childWorkflows=d}])}(),function(){var a=angular.module("nflowExplorer.workflow.graph",[]);a.directive("workflowGraph",function(){return{restrict:"E",replace:!0,scope:{definition:"=",workflow:"="},bindToController:!0,controller:"WorkflowGraphCtrl",controllerAs:"ctrl",template:'<div class="svg-container"><svg id="workflowSvg"/></div>'}}),a.controller("WorkflowGraphCtrl",["$rootScope","WorkflowGraphApi","Graph",function(a,b,c){function d(){var a=e(f.definition,f.workflow);b.registerOnSelectNodeListener(a.nodeSelected),a.drawWorkflowDefinition()}function e(d,e){var f,g=d,h=e,i=c.workflowDefinitionGraph(g,h),j={};return j.drawWorkflowDefinition=function(){c.drawWorkflowDefinition(i,"#workflowSvg",b.onSelectNode,a.graph.css),c.markCurrentState(h)},j.nodeSelected=function(a){console.debug("Selecting node "+a),f&&c.setNodeSelected(i,f,!1),a&&c.setNodeSelected(i,a,!0),f=a},j}var f=this;d()}]),a.factory("WorkflowGraphApi",function(){function a(a){_.forEach(c,function(b){b(a)})}function b(a){c.push(a)}var c=[],d={};return d.onSelectNode=a,d.registerOnSelectNodeListener=b,d})}(),function(){var a=angular.module("nflowExplorer.workflow.info",["nflowExplorer.workflow.graph"]);a.directive("workflowInfo",function(){return{restrict:"E",replace:!0,scope:{workflow:"=",parentWorkflow:"=",childWorkflows:"="},bindToController:!0,controller:"WorkflowInfoCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/workflowInfo.html"}}),a.controller("WorkflowInfoCtrl",["WorkflowGraphApi",function(a){function b(){return _.result(c,"modified","")}var c=this;c.currentStateTime=b,c.selectAction=a.onSelectNode}])}(),function(){var a=angular.module("nflowExplorer.workflow.tabs",["nflowExplorer.workflow.tabs.actionHistory","nflowExplorer.workflow.tabs.stateVariables","nflowExplorer.workflow.tabs.manageState","nflowExplorer.workflow.tabs.manageVariables","nflowExplorer.workflow.tabs.manageSignal"]);a.directive("workflowTabs",function(){return{restrict:"E",replace:!0,scope:{definition:"=",workflow:"=",childWorkflows:"="},bindToController:!0,controller:"WorkflowTabsCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/workflowTabs.html"}}),a.controller("WorkflowTabsCtrl",function(){})}(),function(){var a=angular.module("nflowExplorer.workflow.tabs.actionHistory",["nflowExplorer.workflow.graph"]);a.directive("workflowTabActionHistory",function(){return{restrict:"E",replace:!0,scope:{workflow:"=",childWorkflows:"="},bindToController:!0,controller:"WorkflowTabActionHistoryCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/tabs/actionHistory.html"}}),a.controller("WorkflowTabActionHistoryCtrl",["WorkflowGraphApi",function(a){function b(a){var b=moment(a.executionStartTime),c=moment(a.executionEndTime);if(!b||!c)return"-";var d=moment.duration(c.diff(b));return d<1e3?d+" msec":d.humanize()}function c(a){return _.filter(d.childWorkflows,{parentActionId:a.id})}var d=this;d.selectAction=a.onSelectNode,d.duration=b,d.childWorkflowFromAction=c}])}(),function(){var a=angular.module("nflowExplorer.workflow.tabs.manageState",["nflowExplorer.workflow.graph","nflowExplorer.services","ui.router"]);a.directive("workflowTabManageState",function(){return{restrict:"E",replace:!0,scope:{definition:"=",workflow:"="},bindToController:!0,controller:"WorkflowManageStateCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/tabs/manageState.html"}}),a.controller("WorkflowManageStateCtrl",["$state","WorkflowService","WorkflowGraphApi",function(a,b,c){function d(){e(i.workflow.state),c.registerOnSelectNodeListener(function(a){e(a)})}function e(a){h.nextState=_.first(_.filter(i.definition.states,function(b){return b.id===a}))}function f(){console.info("updateWorkflow()",h);var a=moment(new Date),c={};h.nextState&&(c.state=h.nextState.id),_.isNumber(h.duration)&&h.timeUnit&&(c.nextActivationTime=a.add(moment.duration(h.duration,h.timeUnit))),h.actionDescription&&(c.actionDescription=h.actionDescription),b.update(i.workflow.id,c).then(g)}function g(){a.reload()}var h={};h.timeUnits=["minutes","hours","days"],h.timeUnit=h.timeUnits[0],h.duration=0;var i=this;i.model=h,i.updateWorkflow=f,d()}])}(),function(){var a=angular.module("nflowExplorer.workflow.tabs.manageVariables",["nflowExplorer.services","ui.router"]);a.directive("workflowTabManageVariables",function(){return{restrict:"E",replace:!0,scope:{definition:"=",workflow:"="},bindToController:!0,controller:"WorkflowManageVariablesCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/tabs/manageVariables.html"}}),a.controller("WorkflowManageVariablesCtrl",["$state","WorkflowService",function(a,b){function c(){console.info("updateWorkflow()",e);var a={};e.variableName&&e.variableValue&&(a.stateVariables={},a.stateVariables[e.variableName]=e.variableValue),e.actionDescription&&(a.actionDescription=e.actionDescription),b.update(f.workflow.id,a).then(d)}function d(){a.reload()}var e={},f=this;f.model=e,f.updateWorkflow=c}])}(),function(){var a=angular.module("nflowExplorer.workflow.tabs.manageSignal",["nflowExplorer.services","ui.router"]);a.directive("workflowTabManageSignal",function(){return{restrict:"E",replace:!0,scope:{definition:"=",workflow:"="},bindToController:!0,controller:"WorkflowManageSignalCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/tabs/manageSignal.html"}}),a.controller("WorkflowManageSignalCtrl",["$state","WorkflowService",function(a,b){function c(){var a={signal:e.signal.value,reason:e.signalReason};b.signal(f.workflow.id,a).then(d)}function d(){a.reload()}var e={},f=this;f.model=e,f.signalWorkflow=c}])}(),function(){var a=angular.module("nflowExplorer.workflow.tabs.stateVariables",[]);a.directive("workflowTabStateVariables",function(){return{restrict:"E",replace:!0,scope:{workflow:"="},bindToController:!0,controller:"WorkflowTabStateVariablesCtrl",controllerAs:"ctrl",templateUrl:"app/workflow/tabs/stateVariables.html"}}),a.controller("WorkflowTabStateVariablesCtrl",function(){})}(),function(){var a=angular.module("nflowExplorer.workflowDefinition",["nflowExplorer.workflowDefinition.tabs"]);a.controller("WorkflowDefinitionCtrl",["definition",function(a){var b=this;b.definition=a}])}(),function(){var a=angular.module("nflowExplorer.workflowDefinition.graph",[]);a.directive("workflowDefinitionGraph",function(){return{restrict:"E",replace:!0,scope:{definition:"="},bindToController:!0,controller:"WorkflowDefinitionGraphCtrl",controllerAs:"ctrl",templateUrl:"app/workflow-definition/workflowDefinitionGraph.html"}}),a.controller("WorkflowDefinitionGraphCtrl",["$rootScope","$scope","WorkflowDefinitionGraphApi","Graph",function(a,b,c,d){function e(){j=h(),k=i(l.definition),c.initialize(k.nodeSelected);var a=(new Date).getTime();k.drawWorkflowDefinition(),console.debug("Rendering dagre graph took",(new Date).getTime()-a,"ms")}function f(){console.info("Save PNG"),k.save(function(){d.downloadImage(j.size(),j.dataUrl(),l.definition.type+".png","image/png")})}function g(){console.info("Save SVG"),k.save(function(){d.downloadDataUrl(j.dataUrl(),l.definition.type+".svg")})}function h(){var a="#dagreSvg",b=$(a).width()/$(a).height(),c={};return c.selector=a,c.dataUrl=function(){var b=d3.select(a).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().outerHTML;return"data:image/svg+xml;base64,"+btoa(b)},c.size=function(){var c=$(a).height();return[c*b,c]},c}function i(b){var e=d.workflowDefinitionGraph(b),f={};return f.drawWorkflowDefinition=function(){d.drawWorkflowDefinition(e,j.selector,c.onSelectNode,a.graph.css)},f.nodeSelected=function(a){var b=c.selectedNode;console.debug("Selecting node "+a),b&&d.setNodeSelected(e,b,!1),a&&d.setNodeSelected(e,a,!0)},f.save=function(a){var b=c.selectedNode;f.nodeSelected(null),a(),f.nodeSelected(b)},f}var j,k,l=this;l.savePng=f,l.saveSvg=g,e()}]),a.factory("WorkflowDefinitionGraphApi",["$timeout",function(a){function b(a){d=a}function c(b){a(function(){d(b),e.selectedNode=b})}var d=_.noop,e={};return e.initialize=b,e.onSelectNode=c,e.selectedNode=void 0,e}])}(),function(){var a=["created","inProgress","executing","finished","manual"],b=["queued","sleeping","executing","manual"],c=angular.module("nflowExplorer.workflowDefinition.tabs",["nflowExplorer.workflowDefinition.tabs.workflowStatisticsTable","nflowExplorer.workflowDefinition.tabs.workflowSignalsTable","nvd3"]);c.directive("workflowDefinitionTabs",function(){return{restrict:"E",replace:!0,scope:{definition:"="},bindToController:!0,controller:"WorkflowDefinitionTabsCtrl",controllerAs:"ctrl",templateUrl:"app/workflow-definition/workflowDefinitionTabs.html"}}),c.controller("WorkflowDefinitionTabsCtrl",["$rootScope","$scope","WorkflowDefinitionGraphApi","WorkflowStatsPoller","$timeout",function(c,d,e,f,g){function h(){l(p.definition.type),f.start(p.definition.type),d.$on("workflowStatsUpdated",function(a,b){b===p.definition.type&&l(b)})}function i(a){return a.id===e.selectedNode}function j(a,c){var d={},e=_.map(a.states,function(a){return a.id}),f=Object.keys(c.stateStatistics),g=e.concat(_.filter(f,function(a){return!_.includes(e,a)})),h=_.filter(g,function(b){var c=_.find(a.states,{id:b});return!c||"end"!==c.type}),i=b;return _.forEach(i,function(a){d[a]||(d[a]={key:_.startCase(a),values:_.map(h,function(a){return{label:a,value:0}})})}),_.forEach(c.stateStatistics,function(a,b){_.includes(h,b)&&_.forEach(a,function(a,c){k(b,c,a,d)})}),_.values(d)}function k(a,b,c,d){var e;if("created"===b||"inProgress"===b){var f=c.queuedInstances||0,g=c.allInstances||0,h=g-f;e=_.find(d.sleeping.values,{label:a}),e.value+=h,e=_.find(d.queued.values,{label:a}),e.value+=f}else"manual"===b?(e=_.find(d.manual.values,{label:a}),e.value=c.allInstances||0):"executing"===b&&(e=_.find(d.executing.values,{label:a}),e.value=c.allInstances||0)}function l(a){var b=f.getLatest(a);if(!p.definition)return void console.debug("Definition not loaded yet");if(b){if(n(p.definition,b),0===Object.keys(b).length)return;p.data=j(p.definition,b)}}function m(b){var c=[].concat(a);return c.concat(_.flatten(_.map(b,function(a){return _.keys(a)}))),_.uniq(c)}function n(a,b){var c=m(b),d={allInstances:0,queuedInstances:0};return _.forEach(c,function(a){d[a]={allInstances:0,queuedInstances:0}}),b.stateStatistics||(b.stateStatistics={}),_.forEach(a.states,function(a){function e(a){return a?a.queuedInstances:0}function f(a){return a?a.allInstances-a.queuedInstances:0}var g=a.id;a.stateStatistics=b.stateStatistics[g]||{},a.stateStatistics.allInstances=_.reduce(_.values(a.stateStatistics),function(a,b){return a+b.allInstances},0),a.stateStatistics.queuedInstances=_.reduce(_.values(a.stateStatistics),function(a,b){return a+b.queuedInstances||0},0),_.forEach(c,function(b){
if(a.stateStatistics[b]){var c=a.stateStatistics[b].allInstances||0,e=a.stateStatistics[b].queuedInstances||0;d[b].allInstances+=c,d[b].queuedInstances+=e,d.allInstances+=c,d.queuedInstances+=e}}),a.stateStatistics.queued={allInstances:e(a.stateStatistics.created)+e(a.stateStatistics.inProgress)},a.stateStatistics.sleeping={allInstances:f(a.stateStatistics.created)+f(a.stateStatistics.inProgress)}}),a.stateStatisticsTotal=d,b}function o(){c.$broadcast("startRadiator")}var p=this;p.hasStatistics=!1,p.selectNode=e.onSelectNode,p.isStateSelected=i,p.startRadiator=o;var q=450,r=400;p.options={chart:{type:"multiBarChart",callback:function(a){a.container.setAttribute("preserveAspectRatio","xMinYMin");var b=Math.min(q,r);a.container.setAttribute("viewBox","0 0 "+b+" "+b),g(function(){a.stacked(!0),a.update()})},height:r,width:q,margin:{top:20,right:20,bottom:160,left:45},noData:"No workflow instances in active states. There may be finished instances.",x:function(a){return a.label},y:function(a){return a.value},clipEdge:!0,staggerLabels:!1,reduceXTicks:!1,showControls:!0,duration:0,transitionDuration:0,stacked:!0,xAxis:{showMaxMin:!1,rotateLabels:25},yAxis:{axisLabel:"Workflow instances",axisLabelDistance:40,tickFormat:function(a){return d3.format(",d")(a)}}}},h()}])}(),function(){var a=angular.module("nflowExplorer.workflowDefinition.tabs.workflowSignalsTable",[]);a.directive("workflowSignalsTable",function(){return{restrict:"E",replace:!0,scope:{definition:"="},bindToController:!0,controller:"WorkflowSignalsTable",controllerAs:"ctrl",templateUrl:"app/workflow-definition/tabs/workflowSignalsTable.html"}}),a.controller("WorkflowSignalsTable",function(){})}(),function(){var a=angular.module("nflowExplorer.workflowDefinition.tabs.workflowStatisticsTable",["nflowExplorer.workflowDefinition.graph"]);a.directive("workflowStatisticsTable",function(){return{restrict:"E",replace:!0,scope:{definition:"="},bindToController:!0,controller:"WorkflowStatisticsTable",controllerAs:"ctrl",templateUrl:"app/workflow-definition/tabs/workflowStatisticsTable.html"}}),a.controller("WorkflowStatisticsTable",["WorkflowDefinitionGraphApi",function(a){function b(b){return b.id===a.selectedNode}var c=this;c.isStateSelected=b,c.selectNode=a.onSelectNode}])}(),angular.module("nflowExplorer.workflowStats",[]).controller("WorkflowStatsCtrl",["$scope","$rootScope","$interval","WorkflowDefinitionService","$stateParams","config",function(a,b,c,d,e,f){function g(){b.radiator&&b.radiator.radiatorStatsTask&&c.cancel(b.radiator.radiatorStatsTask),b.radiator={},b.radiator.type=a.type,b.radiator.stateChart={},b.radiator.stateChart.data=[],a.graphs={}}function h(a){return _.reduce(a,function(a,b){return _.map(b[1],function(a,b){return b})},{}).sort()}function i(a){return _.reduce(a,function(a,b){return b?a+b:a},0)}function j(a){var c=b.radiator.stateChart.data,d=_.map(c,function(b){var c=b[0],d=b[1],e=_.map(a,function(a){if(d){var b=d[a];return b?i(_.map(_.values(b),function(a){return a.allInstances})):0}});return[c].concat(e)}),e={dataArray:d,labels:a};return e}function k(a){var c=b.radiator.stateChart.data,d=["queued","sleeping","executing","manual"],e=["executing","manual"],f=_.map(c,function(b){var c=b[0],d=b[1],f=0,g=0,h=_.map(e,function(b){return i(_.map(a,function(a){if(d){var c=d[a];return c&&c[b]?c[b].allInstances:0}}))});return f=i(_.map(d,function(a){return a.created?a.created.queuedInstances:0+a.inProgress?a.inProgress.queuedInstances:0})),g=i(_.map(d,function(a){return a.created?a.created.allInstances-a.created.queuedInstances:0+a.inProgress?a.inProgress.allInstances-a.inProgress.queuedInstances:0})),[c].concat([f,g]).concat(h)});return{dataArray:f,labels:_.map(d,_.startCase)}}function l(b,c){var d=document.getElementById(b);if(d){var e=["timestamp"].concat(c.labels);if(a.graphs[b])a.graphs[b].updateOptions({file:c.dataArray,labels:e});else{var f={axisLabelFontSize:13,responsive:!0,stackedGraph:!0,legend:"always",labelsDiv:b+"Legend",labelsSeparateLines:!0,labels:e,axes:{x:{axisLabelWidth:55}}};a.graphs[b]=new Dygraph(d,c.dataArray,f)}}}function m(a,c){var d=b.radiator.stateChart.data;for(d.push([a,c]);d.length>q;)d.shift()}function n(b){return _.filter(b,function(b){var c=_.first(_.filter(a.definition.states,function(a){return a.id===b}));return!c||"end"!==c.type})}function o(){var a=h(b.radiator.stateChart.data);a=n(a),l("stateChart",j(a)),l("executionChart",k(a))}function p(){d.getStats(a.type).then(function(a){console.info("Fetching statistics",a),m(new Date,a.stateStatistics),o()})["catch"](function(a){console.error(a),m(new Date,{}),o()})}a.type=e.type;var q=f.maxHistorySize;a.definition={},a.definition.states=[],a.graphs||(a.graphs={}),b.radiator?b.radiator.type!==a.type&&g():g(),d.get(a.type).then(function(b){a.definition=_.first(b)}),a.$on("$destroy",function(){a.graphs={}}),a.$on("startRadiator",function(){p(),b.radiator.radiatorStatsTask||(b.radiator.radiatorStatsTask=c(p,1e3*f.radiator.pollPeriod))})}]);