<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CppVisitor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RobotArdu</a> &gt; <a href="index.source.html" class="el_package">de.fhg.iais.roberta.syntax.codegen.arduino.bob3</a> &gt; <span class="el_source">CppVisitor.java</span></div><h1>CppVisitor.java</h1><pre class="source lang-java linenums">package de.fhg.iais.roberta.syntax.codegen.arduino.bob3;

import java.util.ArrayList;
import java.util.Set;

import de.fhg.iais.roberta.components.UsedSensor;
import de.fhg.iais.roberta.syntax.Phrase;
import de.fhg.iais.roberta.syntax.action.control.RelayAction;
import de.fhg.iais.roberta.syntax.action.display.ClearDisplayAction;
import de.fhg.iais.roberta.syntax.action.display.ShowPictureAction;
import de.fhg.iais.roberta.syntax.action.display.ShowTextAction;
import de.fhg.iais.roberta.syntax.action.light.LightAction;
import de.fhg.iais.roberta.syntax.action.light.LightStatusAction;
import de.fhg.iais.roberta.syntax.action.motor.CurveAction;
import de.fhg.iais.roberta.syntax.action.motor.DriveAction;
import de.fhg.iais.roberta.syntax.action.motor.MotorDriveStopAction;
import de.fhg.iais.roberta.syntax.action.motor.MotorGetPowerAction;
import de.fhg.iais.roberta.syntax.action.motor.MotorOnAction;
import de.fhg.iais.roberta.syntax.action.motor.MotorSetPowerAction;
import de.fhg.iais.roberta.syntax.action.motor.MotorStopAction;
import de.fhg.iais.roberta.syntax.action.motor.TurnAction;
import de.fhg.iais.roberta.syntax.action.sound.PlayFileAction;
import de.fhg.iais.roberta.syntax.action.sound.PlayNoteAction;
import de.fhg.iais.roberta.syntax.action.sound.SayTextAction;
import de.fhg.iais.roberta.syntax.action.sound.SetLanguageAction;
import de.fhg.iais.roberta.syntax.action.sound.ToneAction;
import de.fhg.iais.roberta.syntax.action.sound.VolumeAction;
import de.fhg.iais.roberta.syntax.actors.arduino.PinWriteValueAction;
import de.fhg.iais.roberta.syntax.actors.arduino.SerialWriteAction;
import de.fhg.iais.roberta.syntax.actors.arduino.bob3.BodyLEDAction;
import de.fhg.iais.roberta.syntax.actors.arduino.bob3.RecallAction;
import de.fhg.iais.roberta.syntax.actors.arduino.bob3.ReceiveIRAction;
import de.fhg.iais.roberta.syntax.actors.arduino.bob3.RememberAction;
import de.fhg.iais.roberta.syntax.actors.arduino.bob3.SendIRAction;
import de.fhg.iais.roberta.syntax.actors.arduino.mbot.ExternalLedOffAction;
import de.fhg.iais.roberta.syntax.actors.arduino.mbot.ExternalLedOnAction;
import de.fhg.iais.roberta.syntax.actors.arduino.mbot.LedOffAction;
import de.fhg.iais.roberta.syntax.actors.arduino.mbot.LedOnAction;
import de.fhg.iais.roberta.syntax.check.hardware.arduino.bob3.UsedHardwareCollectorVisitor;
import de.fhg.iais.roberta.syntax.codegen.arduino.ArduinoVisitor;
import de.fhg.iais.roberta.syntax.lang.blocksequence.MainTask;
import de.fhg.iais.roberta.syntax.lang.expr.ColorConst;
import de.fhg.iais.roberta.syntax.lang.expr.RgbColor;
import de.fhg.iais.roberta.syntax.sensor.generic.InfraredSensor;
import de.fhg.iais.roberta.syntax.sensor.generic.LightSensor;
import de.fhg.iais.roberta.syntax.sensor.generic.PinTouchSensor;
import de.fhg.iais.roberta.syntax.sensor.generic.TemperatureSensor;
import de.fhg.iais.roberta.syntax.sensors.arduino.bob3.CodePadSensor;
import de.fhg.iais.roberta.syntax.sensors.arduino.bob3.GetSampleSensor;
import de.fhg.iais.roberta.typecheck.BlocklyType;
import de.fhg.iais.roberta.visitor.AstVisitor;
import de.fhg.iais.roberta.visitor.actor.AstActorLightVisitor;
import de.fhg.iais.roberta.visitors.arduino.Bob3AstVisitor;

/**
 * This class is implementing {@link AstVisitor}. All methods are implemented and they append a human-readable C representation of a phrase to a StringBuilder.
 * &lt;b&gt;This representation is correct C code for Arduino.&lt;/b&gt; &lt;br&gt;
 */
public class CppVisitor extends ArduinoVisitor implements Bob3AstVisitor&lt;Void&gt;, AstActorLightVisitor&lt;Void&gt; {
    private final boolean isTimerSensorUsed;
    private final Set&lt;UsedSensor&gt; usedTimer;

    /**
     * Initialize the C++ code generator visitor.
     *
     * @param brickConfiguration hardware configuration of the brick
     * @param programPhrases to generate the code from
     * @param indentation to start with. Will be incr/decr depending on block structure
     */
    private CppVisitor(ArrayList&lt;ArrayList&lt;Phrase&lt;Void&gt;&gt;&gt; phrases, int indentation) {
<span class="fc" id="L71">        super(phrases, indentation);</span>
<span class="fc" id="L72">        UsedHardwareCollectorVisitor codePreprocessVisitor = new UsedHardwareCollectorVisitor(phrases);</span>
<span class="fc" id="L73">        this.usedVars = codePreprocessVisitor.getVisitedVars();</span>
<span class="fc" id="L74">        this.isTimerSensorUsed = codePreprocessVisitor.isTimerSensorUsed();</span>
<span class="fc" id="L75">        this.usedTimer = codePreprocessVisitor.getTimer();</span>
<span class="fc" id="L76">        this.loopsLabels = codePreprocessVisitor.getloopsLabelContainer();</span>
<span class="fc" id="L77">    }</span>

    /**
     * factory method to generate C++ code from an AST.&lt;br&gt;
     *
     * @param brickConfiguration hardware configuration of the brick
     * @param programPhrases to generate the code from
     * @param withWrapping if false the generated code will be without the surrounding configuration code
     */
    public static String generate(ArrayList&lt;ArrayList&lt;Phrase&lt;Void&gt;&gt;&gt; programPhrases, boolean withWrapping) {
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        CppVisitor astVisitor = new CppVisitor(programPhrases, withWrapping ? 1 : 0);</span>
<span class="fc" id="L88">        astVisitor.generateCode(withWrapping);</span>
<span class="fc" id="L89">        return astVisitor.sb.toString();</span>
    }

    @Override
    public Void visitColorConst(ColorConst&lt;Void&gt; colorConst) {
<span class="nc" id="L94">        this.sb.append(colorConst.getValue());</span>
<span class="nc" id="L95">        return null;</span>
    }

    @Override
    protected String getLanguageVarTypeFromBlocklyType(BlocklyType type) {
<span class="pc bpc" id="L100" title="13 of 14 branches missed.">        switch ( type ) {</span>
            case ANY:
            case COMPARABLE:
            case ADDABLE:
            case NULL:
            case REF:
            case PRIM:
            case NOTHING:
            case CAPTURED_TYPE:
            case R:
            case S:
            case T:
<span class="nc" id="L112">                return &quot;&quot;;</span>
            case ARRAY:
<span class="nc" id="L114">                return &quot;double&quot;;</span>
            case ARRAY_NUMBER:
<span class="nc" id="L116">                return &quot;double&quot;;</span>
            case ARRAY_STRING:
<span class="nc" id="L118">                return &quot;String&quot;;</span>
            case ARRAY_BOOLEAN:
<span class="nc" id="L120">                return &quot;bool&quot;;</span>
            case ARRAY_COLOUR:
<span class="nc" id="L122">                return &quot;Bob3Color&quot;;</span>
            case BOOLEAN:
<span class="nc" id="L124">                return &quot;bool&quot;;</span>
            case NUMBER:
<span class="fc" id="L126">                return &quot;double&quot;;</span>
            case NUMBER_INT:
<span class="nc" id="L128">                return &quot;int&quot;;</span>
            case STRING:
<span class="nc" id="L130">                return &quot;String&quot;;</span>
            case VOID:
<span class="nc" id="L132">                return &quot;void&quot;;</span>
            case COLOR:
<span class="nc" id="L134">                return &quot;Bob3Color&quot;;</span>
            case CONNECTION:
<span class="nc" id="L136">                return &quot;int&quot;;</span>
            default:
<span class="nc" id="L138">                throw new IllegalArgumentException(&quot;unhandled type&quot;);</span>
        }
    }

    @Override
    public Void visitInfraredSensor(InfraredSensor&lt;Void&gt; infraredSensor) {
<span class="fc" id="L144">        this.sb.append(&quot;myBob.getIRLight()&quot;);</span>
<span class="fc" id="L145">        return null;</span>
    }

    @Override
    public Void visitTemperatureSensor(TemperatureSensor&lt;Void&gt; temperatureSensor) {
<span class="fc" id="L150">        this.sb.append(&quot;myBob.getTemperature()&quot;);</span>
<span class="fc" id="L151">        return null;</span>
    }

    @Override
    public Void visitMainTask(MainTask&lt;Void&gt; mainTask) {
<span class="fc" id="L156">        decrIndentation();</span>
<span class="fc" id="L157">        mainTask.getVariables().visit(this);</span>
<span class="fc" id="L158">        nlIndent();</span>
<span class="pc bpc" id="L159" title="2 of 4 branches missed.">        if ( this.isTimerSensorUsed || this.usedTimer.toString().contains(&quot;TIMER&quot;) ) {</span>
<span class="nc" id="L160">            this.sb.append(&quot;unsigned long __time = millis();&quot;);</span>
<span class="nc" id="L161">            nlIndent();</span>
        }
<span class="fc" id="L163">        generateUserDefinedMethods();</span>
<span class="fc" id="L164">        nlIndent();</span>
<span class="fc" id="L165">        this.sb.append(&quot;void setup()&quot;);</span>
<span class="fc" id="L166">        nlIndent();</span>
<span class="fc" id="L167">        incrIndentation();</span>
<span class="fc" id="L168">        this.sb.append(&quot;{&quot;);</span>
<span class="fc" id="L169">        nlIndent();</span>
<span class="fc" id="L170">        this.sb.append(&quot;Serial.begin(9600); &quot;);</span>
<span class="fc" id="L171">        generateUsedVars();</span>
<span class="fc" id="L172">        decrIndentation();</span>
<span class="fc" id="L173">        nlIndent();</span>
<span class="fc" id="L174">        this.sb.append(&quot;}&quot;);</span>
<span class="fc" id="L175">        nlIndent();</span>
<span class="fc" id="L176">        return null;</span>
    }

    @Override
    protected void generateProgramPrefix(boolean withWrapping) {
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if ( !withWrapping ) {</span>
<span class="fc" id="L182">            return;</span>
        }

<span class="nc" id="L185">        this.sb.append(&quot;#include &lt;math.h&gt; \n&quot;);</span>
<span class="nc" id="L186">        this.sb.append(&quot;#include &lt;BOB3.h&gt; \n&quot;);</span>
<span class="nc" id="L187">        this.sb.append(&quot;#include &lt;Wire.h&gt;\n&quot;);</span>
<span class="nc" id="L188">        this.sb.append(&quot;#include &lt;SoftwareSerial.h&gt;\n&quot;);</span>
<span class="nc" id="L189">        this.sb.append(&quot;#include &lt;RobertaFunctions.h&gt;\n&quot;);</span>
<span class="nc" id="L190">        this.sb.append(&quot;RobertaFunctions rob;\n&quot;);</span>
<span class="nc" id="L191">        this.sb.append(&quot;Bob3 myBob;\n&quot;);</span>

<span class="nc" id="L193">    }</span>

    @Override
    protected void generateProgramSuffix(boolean withWrapping) {
//        if ( withWrapping ) {
//            this.sb.append(&quot;\n}\n&quot;);
//        }
<span class="fc" id="L200">    }</span>

    @Override
    public Void visitLightAction(LightAction&lt;Void&gt; lightAction) {
<span class="nc" id="L204">        this.sb.append(&quot;myBob.setWhiteLeds(WHITE, WHITE);&quot;);</span>
<span class="nc" id="L205">        return null;</span>
    }

    @Override
    public Void visitLightStatusAction(LightStatusAction&lt;Void&gt; lightStatusAction) {
<span class="nc" id="L210">        this.sb.append(&quot;myBob.setLed(2, OFF);&quot;);</span>
<span class="nc" id="L211">        this.sb.append(&quot;myBob.setLed(1, OFF);&quot;);</span>
<span class="nc" id="L212">        return null;</span>
    }

    @Override
    public Void visitRgbColor(RgbColor&lt;Void&gt; rgbColor) {
<span class="nc" id="L217">        this.sb.append(&quot;(&quot;);</span>
<span class="nc" id="L218">        rgbColor.getR().visit(this);</span>
<span class="nc" id="L219">        this.sb.append(&quot;)&quot;);</span>
<span class="nc" id="L220">        this.sb.append(&quot;*256*256 + &quot;);</span>
<span class="nc" id="L221">        this.sb.append(&quot;(&quot;);</span>
<span class="nc" id="L222">        rgbColor.getG().visit(this);</span>
<span class="nc" id="L223">        this.sb.append(&quot;)&quot;);</span>
<span class="nc" id="L224">        this.sb.append(&quot;*256 + &quot;);</span>
<span class="nc" id="L225">        this.sb.append(&quot;(&quot;);</span>
<span class="nc" id="L226">        rgbColor.getB().visit(this);</span>
<span class="nc" id="L227">        this.sb.append(&quot;)&quot;);</span>
<span class="nc" id="L228">        return null;</span>
    }

    @Override
    public Void visitLightSensor(LightSensor&lt;Void&gt; lightSensor) {
<span class="nc" id="L233">        this.sb.append(&quot;myBob.getIRSensor()&quot;);</span>
<span class="nc" id="L234">        return null;</span>
    }

    @Override
    public Void visitPinTouchSensor(PinTouchSensor&lt;Void&gt; pinTouchSensor) {
<span class="fc bfc" id="L239" title="All 2 branches covered.">        if ( pinTouchSensor.getSlot().getValues()[0].equals(&quot;0&quot;) ) {</span>
<span class="fc" id="L240">            this.sb.append(&quot;( myBob.getArm(&quot; + pinTouchSensor.getPort().getOraName() + &quot;) &gt; &quot; + pinTouchSensor.getSlot().getValues()[0] + &quot; )&quot;);</span>
        } else {
<span class="fc" id="L242">            this.sb.append(&quot;( myBob.getArm(&quot; + pinTouchSensor.getPort().getOraName() + &quot;) == &quot; + pinTouchSensor.getSlot().getValues()[0] + &quot; )&quot;);</span>
        }
<span class="fc" id="L244">        return null;</span>
    }

    @Override
    public Void visitLedOnAction(LedOnAction&lt;Void&gt; ledOnAction) {
<span class="nc" id="L249">        this.sb.append(&quot;myBob.setLed(&quot;);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if ( ledOnAction.getSide().equals(&quot;Left&quot;) ) {</span>
<span class="nc" id="L251">            this.sb.append(&quot;EYE_2, &quot;);</span>
        } else {
<span class="nc" id="L253">            this.sb.append(&quot;EYE_1, &quot;);</span>
        }
<span class="nc" id="L255">        ledOnAction.getLedColor().visit(this);</span>
<span class="nc" id="L256">        this.sb.append(&quot;);&quot;);</span>
<span class="nc" id="L257">        return null;</span>
    }

    @Override
    public Void visitClearDisplayAction(ClearDisplayAction&lt;Void&gt; clearDisplayAction) {
<span class="nc" id="L262">        return null;</span>
    }

    @Override
    public Void visitShowPictureAction(ShowPictureAction&lt;Void&gt; showPictureAction) {
<span class="nc" id="L267">        return null;</span>
    }

    @Override
    public Void visitShowTextAction(ShowTextAction&lt;Void&gt; showTextAction) {
<span class="nc" id="L272">        return null;</span>
    }

    @Override
    public Void visitDriveAction(DriveAction&lt;Void&gt; driveAction) {
<span class="nc" id="L277">        return null;</span>
    }

    @Override
    public Void visitCurveAction(CurveAction&lt;Void&gt; curveAction) {
<span class="nc" id="L282">        return null;</span>
    }

    @Override
    public Void visitTurnAction(TurnAction&lt;Void&gt; turnAction) {
<span class="nc" id="L287">        return null;</span>
    }

    @Override
    public Void visitMotorGetPowerAction(MotorGetPowerAction&lt;Void&gt; motorGetPowerAction) {
<span class="nc" id="L292">        return null;</span>
    }

    @Override
    public Void visitMotorOnAction(MotorOnAction&lt;Void&gt; motorOnAction) {
<span class="nc" id="L297">        return null;</span>
    }

    @Override
    public Void visitMotorSetPowerAction(MotorSetPowerAction&lt;Void&gt; motorSetPowerAction) {
<span class="nc" id="L302">        return null;</span>
    }

    @Override
    public Void visitMotorStopAction(MotorStopAction&lt;Void&gt; motorStopAction) {
<span class="nc" id="L307">        return null;</span>
    }

    @Override
    public Void visitMotorDriveStopAction(MotorDriveStopAction&lt;Void&gt; stopAction) {
<span class="nc" id="L312">        return null;</span>
    }

    @Override
    public Void visitToneAction(ToneAction&lt;Void&gt; toneAction) {
<span class="nc" id="L317">        return null;</span>
    }

    @Override
    public Void visitPlayNoteAction(PlayNoteAction&lt;Void&gt; playNoteAction) {
<span class="nc" id="L322">        return null;</span>
    }

    @Override
    public Void visitVolumeAction(VolumeAction&lt;Void&gt; volumeAction) {
<span class="nc" id="L327">        return null;</span>
    }

    @Override
    public Void visitSetLanguageAction(SetLanguageAction&lt;Void&gt; setLanguageAction) {
<span class="nc" id="L332">        return null;</span>
    }

    @Override
    public Void visitSayTextAction(SayTextAction&lt;Void&gt; sayTextAction) {
<span class="nc" id="L337">        return null;</span>
    }

    @Override
    public Void visitPlayFileAction(PlayFileAction&lt;Void&gt; playFileAction) {
        // TODO Auto-generated method stub
<span class="nc" id="L343">        return null;</span>
    }

    @Override
    public Void visitLedOffAction(LedOffAction&lt;Void&gt; ledOffAction) {
<span class="nc" id="L348">        this.sb.append(&quot;myBob.setLed(&quot;);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if ( ledOffAction.getSide().equals(&quot;Left&quot;) ) {</span>
<span class="nc" id="L350">            this.sb.append(&quot;EYE_2, OFF);&quot;);</span>
        } else {
<span class="nc" id="L352">            this.sb.append(&quot;EYE_1, OFF);&quot;);</span>
        }
<span class="nc" id="L354">        return null;</span>
    }

    @Override
    public Void visitBodyLEDAction(BodyLEDAction&lt;Void&gt; bodyLEDAction) {
<span class="nc" id="L359">        this.sb.append(&quot;myBob.setLed(&quot;);</span>
<span class="nc" id="L360">        this.sb.append(bodyLEDAction.getSide() + &quot;, &quot;);</span>
<span class="nc" id="L361">        this.sb.append(bodyLEDAction.getledState() + &quot;);&quot;);</span>
<span class="nc" id="L362">        return null;</span>
    }

    @Override
    public Void visitBob3CodePadSensor(CodePadSensor&lt;Void&gt; codePadSensor) {
<span class="fc" id="L367">        this.sb.append(&quot;myBob.getID()&quot;);</span>
<span class="fc" id="L368">        return null;</span>
    }

    @Override
    public Void visitSendIRAction(SendIRAction&lt;Void&gt; sendIRAction) {
<span class="nc" id="L373">        this.sb.append(&quot;myBob.transmitIRCode(&quot;);</span>
<span class="nc" id="L374">        sendIRAction.getCode().visit(this);</span>
<span class="nc" id="L375">        this.sb.append(&quot;);&quot;);</span>
<span class="nc" id="L376">        return null;</span>
    }

    @Override
    public Void visitReceiveIRAction(ReceiveIRAction&lt;Void&gt; receiveIRAction) {
<span class="nc" id="L381">        this.sb.append(&quot;myBob.receiveIRCode(500)&quot;);</span>
<span class="nc" id="L382">        return null;</span>
    }

    @Override
    public Void visitBob3GetSampleSensor(GetSampleSensor&lt;Void&gt; getSampleSensor) {
<span class="nc" id="L387">        getSampleSensor.getSensor().visit(this);</span>
<span class="nc" id="L388">        return null;</span>
    }

    @Override
    public Void visitExternalLedOnAction(ExternalLedOnAction&lt;Void&gt; externalLedOnAction) {
<span class="nc" id="L393">        return null;</span>
    }

    @Override
    public Void visitExternalLedOffAction(ExternalLedOffAction&lt;Void&gt; externalLedOffAction) {
<span class="nc" id="L398">        return null;</span>
    }

    @Override
    public Void visitRememberAction(RememberAction&lt;Void&gt; rememberAction) {
<span class="nc" id="L403">        this.sb.append(&quot;remember((int)(&quot;);</span>
<span class="nc" id="L404">        rememberAction.getCode().visit(this);</span>
<span class="nc" id="L405">        this.sb.append(&quot;));&quot;);</span>
<span class="nc" id="L406">        return null;</span>
    }

    @Override
    public Void visitRecallAction(RecallAction&lt;Void&gt; recallAction) {
<span class="nc" id="L411">        this.sb.append(&quot;recall()&quot;);</span>
<span class="nc" id="L412">        return null;</span>
    }

    @Override
    public Void visitRelayAction(RelayAction&lt;Void&gt; relayAction) {
<span class="nc" id="L417">        return null;</span>
    }

    @Override
    public Void visitPinWriteValueAction(PinWriteValueAction&lt;Void&gt; pinWriteValueSensor) {
        // TODO Auto-generated method stub
<span class="nc" id="L423">        return null;</span>
    }

    @Override
    public Void visitSerialWriteAction(SerialWriteAction&lt;Void&gt; serialWriteAction) {
        // TODO Auto-generated method stub
<span class="nc" id="L429">        return null;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>