<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppManagerServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app-manager</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.app.manager.service.impl</a> &gt; <span class="el_source">AppManagerServiceImpl.java</span></div><h1>AppManagerServiceImpl.java</h1><pre class="source lang-java linenums">package org.molgenis.app.manager.service.impl;

import com.google.common.collect.Maps;
import com.google.gson.Gson;
import com.google.gson.JsonSyntaxException;
import net.lingala.zip4j.core.ZipFile;
import net.lingala.zip4j.exception.ZipException;
import org.apache.commons.io.IOUtils;
import org.molgenis.app.manager.exception.*;
import org.molgenis.app.manager.meta.App;
import org.molgenis.app.manager.meta.AppFactory;
import org.molgenis.app.manager.meta.AppMetadata;
import org.molgenis.app.manager.model.AppConfig;
import org.molgenis.app.manager.model.AppResponse;
import org.molgenis.app.manager.service.AppManagerService;
import org.molgenis.data.DataService;
import org.molgenis.data.Query;
import org.molgenis.data.file.FileStore;
import org.molgenis.data.plugin.model.Plugin;
import org.molgenis.data.plugin.model.PluginFactory;
import org.molgenis.data.plugin.model.PluginMetadata;
import org.molgenis.data.support.QueryImpl;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Map;

import static com.google.common.collect.Lists.newArrayList;
import static java.io.File.separator;
import static java.nio.charset.StandardCharsets.UTF_8;
import static java.util.Objects.requireNonNull;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.io.FileUtils.deleteDirectory;

@Service
public class AppManagerServiceImpl implements AppManagerService
{
	public static final String APPS_DIR = &quot;apps&quot;;
	public static final String APPS_TMP_DIR = &quot;apps_tmp&quot;;
	public static final String ZIP_FILE_PREFIX = &quot;zip_file_&quot;;
	public static final String ZIP_INDEX_FILE = &quot;index.html&quot;;
	public static final String ZIP_CONFIG_FILE = &quot;config.json&quot;;

	private static final String APP_PLUGIN_ROOT = &quot;app/&quot;;

	private final AppFactory appFactory;
	private final DataService dataService;
	private final FileStore fileStore;
	private final Gson gson;
	private final PluginFactory pluginFactory;

	public AppManagerServiceImpl(AppFactory appFactory, DataService dataService, FileStore fileStore, Gson gson,
			PluginFactory pluginFactory)
<span class="fc" id="L59">	{</span>
<span class="fc" id="L60">		this.appFactory = requireNonNull(appFactory);</span>
<span class="fc" id="L61">		this.dataService = requireNonNull(dataService);</span>
<span class="fc" id="L62">		this.fileStore = requireNonNull(fileStore);</span>
<span class="fc" id="L63">		this.gson = requireNonNull(gson);</span>
<span class="fc" id="L64">		this.pluginFactory = requireNonNull(pluginFactory);</span>
<span class="fc" id="L65">	}</span>

	@Override
	public List&lt;AppResponse&gt; getApps()
	{
<span class="fc" id="L70">		return dataService.findAll(AppMetadata.APP, App.class).map(AppResponse::create).collect(toList());</span>
	}

	@Override
	public AppResponse getAppByUri(String uri)
	{
<span class="fc" id="L76">		Query&lt;App&gt; query = QueryImpl.EQ(AppMetadata.URI, uri);</span>
<span class="fc" id="L77">		App app = dataService.findOne(AppMetadata.APP, query, App.class);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">		if (app == null)</span>
		{
<span class="fc" id="L80">			throw new AppForURIDoesNotExistException(uri);</span>
		}
<span class="fc" id="L82">		return AppResponse.create(app);</span>
	}

	@Override
	@Transactional
	public void activateApp(String id)
	{
		// Set app to active
<span class="fc" id="L90">		App app = getAppById(id);</span>
<span class="fc" id="L91">		app.setActive(true);</span>
<span class="fc" id="L92">		dataService.update(AppMetadata.APP, app);</span>

		// Add plugin to plugin table to enable permissions and menu management
<span class="fc" id="L95">		String pluginId = generatePluginId(app);</span>
<span class="fc" id="L96">		Plugin plugin = pluginFactory.create(pluginId);</span>
<span class="fc" id="L97">		plugin.setLabel(app.getLabel());</span>
<span class="fc" id="L98">		plugin.setDescription(app.getDescription());</span>
<span class="fc" id="L99">		dataService.add(PluginMetadata.PLUGIN, plugin);</span>
<span class="fc" id="L100">	}</span>

	@Override
	@Transactional
	public void deactivateApp(String id)
	{
<span class="fc" id="L106">		App app = getAppById(id);</span>
<span class="fc" id="L107">		app.setActive(false);</span>
<span class="fc" id="L108">		dataService.update(AppMetadata.APP, app);</span>

<span class="fc" id="L110">		String pluginId = generatePluginId(app);</span>
<span class="fc" id="L111">		dataService.deleteById(PluginMetadata.PLUGIN, pluginId);</span>

		// TODO remove from menu JSON?
<span class="fc" id="L114">	}</span>

	@Override
	@Transactional
	public void deleteApp(String id)
	{
<span class="fc" id="L120">		App app = getAppById(id);</span>
		try
		{
<span class="fc" id="L123">			deleteDirectory(fileStore.getFile(app.getResourceFolder()));</span>
		}
<span class="nc" id="L125">		catch (IOException err)</span>
		{
<span class="nc" id="L127">			throw new CouldNotDeleteAppException(id);</span>
<span class="fc" id="L128">		}</span>
<span class="fc" id="L129">		dataService.deleteById(AppMetadata.APP, id);</span>
<span class="fc" id="L130">	}</span>

	@Override
	public String uploadApp(InputStream zipData, String zipFileName, String formFieldName)
			throws IOException, ZipException
	{
<span class="fc" id="L136">		fileStore.createDirectory(APPS_TMP_DIR);</span>
<span class="fc" id="L137">		fileStore.createDirectory(APPS_DIR);</span>

<span class="fc" id="L139">		String tempAppArchiveName = APPS_TMP_DIR + separator + ZIP_FILE_PREFIX + zipFileName;</span>
<span class="fc" id="L140">		ZipFile tempAppArchive = new ZipFile(fileStore.store(zipData, tempAppArchiveName));</span>

<span class="fc bfc" id="L142" title="All 2 branches covered.">		if (!tempAppArchive.isValidZipFile())</span>
		{
<span class="fc" id="L144">			fileStore.delete(APPS_TMP_DIR);</span>
<span class="fc" id="L145">			throw new InvalidAppArchiveException(formFieldName);</span>
		}

<span class="fc" id="L148">		String tempFilesDir = &quot;extracted_&quot; + zipFileName;</span>
<span class="fc" id="L149">		String tempAppDirectoryName = APPS_TMP_DIR + separator + tempFilesDir;</span>
<span class="fc" id="L150">		tempAppArchive.extractAll(fileStore.getStorageDir() + separator + tempAppDirectoryName);</span>

<span class="fc" id="L152">		List&lt;String&gt; missingRequiredFilesList = buildMissingRequiredFiles(</span>
<span class="fc" id="L153">				fileStore.getStorageDir() + separator + tempAppDirectoryName);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">		if (!missingRequiredFilesList.isEmpty())</span>
		{
<span class="fc" id="L156">			fileStore.deleteDirectory(APPS_TMP_DIR);</span>
<span class="fc" id="L157">			throw new AppArchiveMissingFilesException(missingRequiredFilesList);</span>
		}

<span class="fc" id="L160">		return tempAppDirectoryName;</span>
	}

	@Override
	public AppConfig checkAndObtainConfig(String tempDir, String configContent) throws IOException
	{
<span class="pc bpc" id="L166" title="1 of 4 branches missed.">		if (configContent.isEmpty() || !isConfigContentValidJson(configContent))</span>
		{
<span class="fc" id="L168">			fileStore.deleteDirectory(APPS_TMP_DIR);</span>
<span class="fc" id="L169">			throw new InvalidAppConfigException();</span>
		}

<span class="fc" id="L172">		AppConfig appConfig = gson.fromJson(configContent, AppConfig.class);</span>
<span class="fc" id="L173">		List&lt;String&gt; missingAppConfigParams = buildMissingConfigParams(appConfig);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">		if (!missingAppConfigParams.isEmpty())</span>
		{
<span class="fc" id="L176">			fileStore.deleteDirectory(APPS_TMP_DIR);</span>
<span class="fc" id="L177">			throw new AppConfigMissingParametersException(missingAppConfigParams);</span>
		}

<span class="fc bfc" id="L180" title="All 2 branches covered.">		if (fileStore.getFile(APPS_DIR + separator + appConfig.getUri()).exists())</span>
		{
<span class="fc" id="L182">			fileStore.deleteDirectory(APPS_TMP_DIR);</span>
<span class="fc" id="L183">			throw new AppAlreadyExistsException(appConfig.getUri());</span>
		}

<span class="fc" id="L186">		fileStore.move(tempDir, APPS_DIR + separator + appConfig.getUri());</span>
<span class="fc" id="L187">		fileStore.deleteDirectory(APPS_TMP_DIR);</span>

<span class="fc" id="L189">		return appConfig;</span>
	}

	@Override
	@Transactional
	public void configureApp(AppConfig appConfig, String htmlTemplate)
	{
<span class="fc" id="L196">		String appDirName = APPS_DIR + separator + appConfig.getUri();</span>

		// If provided config does not include runtimeOptions, set an empty map
<span class="fc" id="L199">		Map&lt;String, Object&gt; runtimeOptions = appConfig.getRuntimeOptions();</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">		if (runtimeOptions == null)</span>
		{
<span class="nc" id="L202">			runtimeOptions = Maps.newHashMap();</span>
		}

<span class="fc" id="L205">		App newApp = appFactory.create();</span>
<span class="fc" id="L206">		newApp.setLabel(appConfig.getLabel());</span>
<span class="fc" id="L207">		newApp.setDescription(appConfig.getDescription());</span>
<span class="fc" id="L208">		newApp.setAppVersion(appConfig.getVersion());</span>
<span class="fc" id="L209">		newApp.setApiDependency(appConfig.getApiDependency());</span>
<span class="fc" id="L210">		newApp.setTemplateContent(htmlTemplate);</span>
<span class="fc" id="L211">		newApp.setActive(false);</span>
<span class="fc" id="L212">		newApp.setIncludeMenuAndFooter(appConfig.getIncludeMenuAndFooter());</span>
<span class="fc" id="L213">		newApp.setResourceFolder(appDirName);</span>
<span class="fc" id="L214">		newApp.setAppConfig(gson.toJson(runtimeOptions));</span>
<span class="fc" id="L215">		newApp.setUri(appConfig.getUri());</span>

<span class="fc" id="L217">		dataService.add(AppMetadata.APP, newApp);</span>
<span class="fc" id="L218">	}</span>

	@Override
	public String extractFileContent(String appDir, String fileName)
	{
<span class="fc" id="L223">		File indexFile = fileStore.getFile(appDir + separator + fileName);</span>
<span class="fc" id="L224">		return utf8Encodedfiletostring(indexFile);</span>
	}

	private String generatePluginId(App app)
	{
<span class="fc" id="L229">		String pluginId = APP_PLUGIN_ROOT + app.getUri();</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (!pluginId.endsWith(&quot;/&quot;))</span>
		{
<span class="fc" id="L232">			pluginId = pluginId + &quot;/&quot;;</span>
		}
<span class="fc" id="L234">		return pluginId;</span>
	}

	private App getAppById(String id)
	{
<span class="fc" id="L239">		App app = dataService.findOneById(AppMetadata.APP, id, App.class);</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">		if (app == null)</span>
		{
<span class="fc" id="L242">			throw new AppForIDDoesNotExistException(id);</span>
		}
<span class="fc" id="L244">		return app;</span>
	}

	private boolean isConfigContentValidJson(String configContent)
	{
		try
		{
<span class="fc" id="L251">			gson.fromJson(configContent, AppConfig.class);</span>
		}
<span class="nc" id="L253">		catch (JsonSyntaxException e)</span>
		{
<span class="nc" id="L255">			return false;</span>
<span class="fc" id="L256">		}</span>
<span class="fc" id="L257">		return true;</span>
	}

	private String utf8Encodedfiletostring(File file)
	{
<span class="fc" id="L262">		try (FileInputStream fileInputStream = new FileInputStream(file))</span>
		{
<span class="fc" id="L264">			return IOUtils.toString(fileInputStream, UTF_8);</span>
		}
<span class="nc" id="L266">		catch (IOException e)</span>
		{
<span class="nc" id="L268">			throw new InvalidAppConfigException();</span>
		}
	}

	private List&lt;String&gt; buildMissingRequiredFiles(String appDirectoryName)
	{
<span class="fc" id="L274">		List&lt;String&gt; missingFromArchive = newArrayList();</span>

<span class="fc" id="L276">		File indexFile = new File(appDirectoryName + separator + ZIP_INDEX_FILE);</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">		if (!indexFile.exists())</span>
		{
<span class="fc" id="L279">			missingFromArchive.add(ZIP_INDEX_FILE);</span>
		}

<span class="fc" id="L282">		File configFile = new File(appDirectoryName + separator + ZIP_CONFIG_FILE);</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">		if (!configFile.exists())</span>
		{
<span class="fc" id="L285">			missingFromArchive.add(ZIP_CONFIG_FILE);</span>
		}

<span class="fc" id="L288">		return missingFromArchive;</span>
	}

	private List&lt;String&gt; buildMissingConfigParams(AppConfig appConfig)
	{
<span class="fc" id="L293">		List&lt;String&gt; missingConfigParameters = newArrayList();</span>

<span class="fc bfc" id="L295" title="All 2 branches covered.">		if (appConfig.getLabel() == null)</span>
		{
<span class="fc" id="L297">			missingConfigParameters.add(&quot;label&quot;);</span>
		}

<span class="fc bfc" id="L300" title="All 2 branches covered.">		if (appConfig.getDescription() == null)</span>
		{
<span class="fc" id="L302">			missingConfigParameters.add(&quot;description&quot;);</span>
		}

<span class="fc bfc" id="L305" title="All 2 branches covered.">		if (appConfig.getIncludeMenuAndFooter() == null)</span>
		{
<span class="fc" id="L307">			missingConfigParameters.add(&quot;includeMenuAndFooter&quot;);</span>
		}

<span class="fc bfc" id="L310" title="All 2 branches covered.">		if (appConfig.getUri() == null)</span>
		{
<span class="fc" id="L312">			missingConfigParameters.add(&quot;uri&quot;);</span>
		}

<span class="fc bfc" id="L315" title="All 2 branches covered.">		if (appConfig.getVersion() == null)</span>
		{
<span class="fc" id="L317">			missingConfigParameters.add(&quot;version&quot;);</span>
		}

<span class="fc" id="L320">		return missingConfigParameters;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>