<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VcfImporterService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-vcf</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.vcf.importer</a> &gt; <span class="el_source">VcfImporterService.java</span></div><h1>VcfImporterService.java</h1><pre class="source lang-java linenums">package org.molgenis.data.vcf.importer;

import com.google.common.collect.Lists;
import org.molgenis.data.*;
import org.molgenis.data.importer.EntitiesValidationReport;
import org.molgenis.data.importer.EntitiesValidationReportImpl;
import org.molgenis.data.importer.EntityImportReport;
import org.molgenis.data.importer.ImportService;
import org.molgenis.data.meta.MetaDataService;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.meta.model.EntityType;
import org.molgenis.data.meta.model.Package;
import org.molgenis.data.security.permission.PermissionSystemService;
import org.molgenis.data.vcf.VcfFileExtensions;
import org.molgenis.data.vcf.model.VcfAttributes;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.File;
import java.io.IOException;
import java.util.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.stream.StreamSupport;

import static java.util.Objects.requireNonNull;
import static org.molgenis.data.meta.model.PackageMetadata.PACKAGE;
import static org.molgenis.security.core.runas.RunAsSystemAspect.runAsSystem;

@Service
public class VcfImporterService implements ImportService
{
<span class="fc" id="L34">	private static final Logger LOG = LoggerFactory.getLogger(VcfImporterService.class);</span>
	private static final int BATCH_SIZE = 10000;

	private final DataService dataService;
	private final PermissionSystemService permissionSystemService;
	private final MetaDataService metaDataService;

	public VcfImporterService(DataService dataService, PermissionSystemService permissionSystemService,
			MetaDataService metaDataService)

<span class="fc" id="L44">	{</span>
<span class="fc" id="L45">		this.dataService = requireNonNull(dataService);</span>
<span class="fc" id="L46">		this.metaDataService = requireNonNull(metaDataService);</span>
<span class="fc" id="L47">		this.permissionSystemService = requireNonNull(permissionSystemService);</span>
<span class="fc" id="L48">	}</span>

	@Transactional
	@Override
	public EntityImportReport doImport(RepositoryCollection source, DatabaseAction databaseAction, String packageId)
	{
<span class="fc bfc" id="L54" title="All 2 branches covered.">		if (databaseAction != DatabaseAction.ADD)</span>
		{
<span class="fc" id="L56">			throw new IllegalArgumentException(&quot;Only ADD is supported&quot;);</span>
		}
<span class="fc" id="L58">		Package importPackage = metaDataService.getPackage(packageId);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">		if (importPackage == null)</span>
		{
<span class="nc" id="L61">			throw new UnknownEntityException(PACKAGE, packageId);</span>
		}

<span class="fc" id="L64">		List&lt;EntityType&gt; addedEntities = new ArrayList&lt;&gt;();</span>
		EntityImportReport report;

<span class="fc" id="L67">		Iterator&lt;String&gt; it = source.getEntityTypeIds().iterator();</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">		if (it.hasNext())</span>
		{
<span class="fc" id="L70">			try (Repository&lt;Entity&gt; repo = source.getRepository(it.next()))</span>
			{
<span class="fc" id="L72">				report = importVcf(repo, addedEntities, importPackage);</span>
			}
<span class="nc" id="L74">			catch (IOException e)</span>
			{
<span class="nc" id="L76">				throw new MolgenisDataException(e);</span>
<span class="fc" id="L77">			}</span>
		}
		else
		{
<span class="nc" id="L81">			report = new EntityImportReport();</span>
		}
<span class="fc" id="L83">		return report;</span>
	}

	@Override
	public EntitiesValidationReport validateImport(File file, RepositoryCollection source)
	{
<span class="fc" id="L89">		EntitiesValidationReport report = new EntitiesValidationReportImpl();</span>
<span class="fc" id="L90">		Iterator&lt;String&gt; it = source.getEntityTypeIds().iterator();</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">		if (it.hasNext())</span>
		{
<span class="fc" id="L93">			String entityTypeId = it.next();</span>
<span class="fc" id="L94">			EntityType emd = source.getRepository(entityTypeId).getEntityType();</span>

			// Vcf entity
<span class="fc" id="L97">			boolean entityExists = runAsSystem(() -&gt; dataService.hasRepository(entityTypeId));</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">			report.getSheetsImportable().put(entityTypeId, !entityExists);</span>

			// Available Attributes
<span class="fc" id="L101">			List&lt;String&gt; availableAttributeNames = Lists.newArrayList();</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">			for (Attribute attr : emd.getAtomicAttributes())</span>
			{
<span class="fc" id="L104">				availableAttributeNames.add(attr.getName());</span>
<span class="fc" id="L105">			}</span>
<span class="fc" id="L106">			report.getFieldsImportable().put(entityTypeId, availableAttributeNames);</span>

			// Sample entity
<span class="fc" id="L109">			Attribute sampleAttribute = emd.getAttribute(VcfAttributes.SAMPLES);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">			if (sampleAttribute != null)</span>
			{
<span class="fc" id="L112">				String sampleEntityName = sampleAttribute.getRefEntity().getId();</span>
<span class="fc" id="L113">				boolean sampleEntityExists = runAsSystem(() -&gt; dataService.hasRepository(sampleEntityName));</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">				report.getSheetsImportable().put(sampleEntityName, !sampleEntityExists);</span>

<span class="fc" id="L116">				List&lt;String&gt; availableSampleAttributeNames = Lists.newArrayList();</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">				for (Attribute attr : sampleAttribute.getRefEntity().getAtomicAttributes())</span>
				{
<span class="fc" id="L119">					availableSampleAttributeNames.add(attr.getName());</span>
<span class="fc" id="L120">				}</span>
<span class="fc" id="L121">				report.getFieldsImportable().put(sampleEntityName, availableSampleAttributeNames);</span>
			}

		}

<span class="fc" id="L126">		return report;</span>
	}

	@Override
	public boolean canImport(File file, RepositoryCollection source)
	{
<span class="fc bfc" id="L132" title="All 2 branches covered.">		for (String extension : getSupportedFileExtensions())</span>
		{
<span class="fc bfc" id="L134" title="All 2 branches covered.">			if (file.getName().toLowerCase().endsWith(extension))</span>
			{
<span class="fc" id="L136">				return true;</span>
			}
<span class="fc" id="L138">		}</span>

<span class="fc" id="L140">		return false;</span>
	}

	private EntityImportReport importVcf(Repository&lt;Entity&gt; inRepository, List&lt;EntityType&gt; addedEntities,
			Package importPackage) throws IOException
	{

<span class="fc" id="L147">		EntityImportReport report = new EntityImportReport();</span>

<span class="fc" id="L149">		String entityTypeId = inRepository.getName();</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">		if (runAsSystem(() -&gt; dataService.hasRepository(entityTypeId)))</span>
		{
<span class="fc" id="L153">			throw new MolgenisDataException(&quot;Can't overwrite existing &quot; + entityTypeId);</span>
		}

<span class="fc" id="L156">		EntityType entityType = inRepository.getEntityType();</span>
<span class="fc" id="L157">		entityType.setBackend(metaDataService.getDefaultBackend().getName());</span>
<span class="fc" id="L158">		entityType.setPackage(importPackage);</span>

<span class="fc" id="L160">		Repository&lt;Entity&gt; sampleRepository = createSampleRepository(addedEntities, entityType, importPackage);</span>

<span class="fc" id="L162">		Iterator&lt;Entity&gt; inIterator = inRepository.iterator();</span>
<span class="fc" id="L163">		try (Repository&lt;Entity&gt; outRepository = dataService.getMeta().createRepository(entityType))</span>
		{
<span class="fc" id="L165">			permissionSystemService.giveUserWriteMetaPermissions(entityType);</span>

<span class="fc" id="L167">			addedEntities.add(entityType);</span>

<span class="fc bfc" id="L169" title="All 2 branches covered.">			if (sampleRepository != null)</span>
			{
<span class="fc" id="L171">				int sampleEntityCount = addSampleEntities(sampleRepository, inIterator);</span>

<span class="fc" id="L173">				report.addNewEntity(sampleRepository.getName());</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">				if (sampleEntityCount &gt; 0)</span>
				{
<span class="fc" id="L176">					report.addEntityCount(sampleRepository.getName(), sampleEntityCount);</span>
				}
			}

<span class="fc" id="L180">			AtomicInteger vcfEntityCount = new AtomicInteger();</span>
<span class="fc" id="L181">			outRepository.add(StreamSupport.stream(inRepository.spliterator(), false).filter(entity -&gt;</span>
			{
<span class="fc" id="L183">				vcfEntityCount.incrementAndGet();</span>
<span class="fc" id="L184">				return true;</span>
			}));
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">			if (vcfEntityCount.get() &gt; 0)</span>
			{
<span class="fc" id="L188">				report.addEntityCount(entityTypeId, vcfEntityCount.get());</span>
			}
		}

<span class="fc" id="L192">		report.addNewEntity(entityTypeId);</span>

<span class="fc" id="L194">		return report;</span>
	}

	private int addSampleEntities(Repository&lt;Entity&gt; sampleRepository, Iterator&lt;Entity&gt; inIterator)
	{
<span class="fc" id="L199">		int sampleEntityCount = 0;</span>
<span class="fc" id="L200">		List&lt;Entity&gt; batch = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">		while (inIterator.hasNext())</span>
		{
<span class="fc" id="L203">			Entity entity = inIterator.next();</span>

<span class="fc" id="L205">			Iterable&lt;Entity&gt; samples = entity.getEntities(VcfAttributes.SAMPLES);</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">			if (samples != null)</span>
			{
<span class="fc bfc" id="L208" title="All 2 branches covered.">				for (Entity sample : samples)</span>
				{
<span class="fc" id="L210">					batch.add(sample);</span>

<span class="pc bpc" id="L212" title="1 of 2 branches missed.">					if (batch.size() == BATCH_SIZE)</span>
					{
<span class="nc" id="L214">						sampleRepository.add(batch.stream());</span>
<span class="nc" id="L215">						sampleEntityCount += batch.size();</span>
<span class="nc" id="L216">						batch.clear();</span>
					}
<span class="fc" id="L218">				}</span>
			}

<span class="fc" id="L221">		}</span>

<span class="pc bpc" id="L223" title="1 of 2 branches missed.">		if (!batch.isEmpty())</span>
		{
<span class="fc" id="L225">			sampleRepository.add(batch.stream());</span>
<span class="fc" id="L226">			sampleEntityCount += batch.size();</span>
		}
<span class="fc" id="L228">		return sampleEntityCount;</span>
	}

	private Repository&lt;Entity&gt; createSampleRepository(List&lt;EntityType&gt; addedEntities, EntityType entityType,
			Package samplePackage)
	{
		Repository&lt;Entity&gt; sampleRepository;
<span class="fc" id="L235">		Attribute sampleAttribute = entityType.getAttribute(VcfAttributes.SAMPLES);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">		if (sampleAttribute != null)</span>
		{
<span class="fc" id="L238">			EntityType samplesEntityType = sampleAttribute.getRefEntity();</span>
<span class="fc" id="L239">			samplesEntityType.setBackend(metaDataService.getDefaultBackend().getName());</span>
<span class="fc" id="L240">			samplesEntityType.setPackage(samplePackage);</span>
<span class="fc" id="L241">			sampleRepository = dataService.getMeta().createRepository(samplesEntityType);</span>
<span class="fc" id="L242">			permissionSystemService.giveUserWriteMetaPermissions(samplesEntityType);</span>
<span class="fc" id="L243">			addedEntities.add(sampleAttribute.getRefEntity());</span>
<span class="fc" id="L244">		}</span>
		else
		{
<span class="fc" id="L247">			sampleRepository = null;</span>
		}
<span class="fc" id="L249">		return sampleRepository;</span>
	}

	@Override
	public int getOrder()
	{
<span class="nc" id="L255">		return 10;</span>
	}

	@Override
	public List&lt;DatabaseAction&gt; getSupportedDatabaseActions()
	{
<span class="nc" id="L261">		return Lists.newArrayList(DatabaseAction.ADD);</span>
	}

	@Override
	public boolean getMustChangeEntityName()
	{
<span class="nc" id="L267">		return true;</span>
	}

	@Override
	public Set&lt;String&gt; getSupportedFileExtensions()
	{
<span class="fc" id="L273">		return VcfFileExtensions.getVCF();</span>
	}

	@Override
	public Map&lt;String, Boolean&gt; determineImportableEntities(MetaDataService metaDataService,
			RepositoryCollection repositoryCollection, String defaultPackage)
	{
<span class="nc" id="L280">		return metaDataService.determineImportableEntities(repositoryCollection);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>